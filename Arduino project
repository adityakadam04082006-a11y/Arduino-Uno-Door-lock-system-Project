#include <Keypad.h>
#include <Servo.h>
#include <LiquidCrystal.h>
#include <EEPROM.h>  // For saving password permanently

// Servo motors
Servo servoDoor;   // Main door
Servo servoLatch;  // Latch

// LCD setup
LiquidCrystal lcd(12, 11, 5, 4, 3, 2);

// Buzzer pin
int buzzer = 10;

// Default password
String defaultPassword = "1234";
String password = "";
String input_password = "";

// Attempt counter
int attempts = 0;
int maxAttempts = 3;

// Keypad setup
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};
byte rowPins[ROWS] = {9, 8, 7, 6};
byte colPins[COLS] = {A0, A1, A2, A3};

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// -------------------------------------------
// Setup function
// -------------------------------------------
void setup() {
  // Attach servos
  servoDoor.attach(13);   
  servoLatch.attach(6);  

  servoDoor.write(0);     
  servoLatch.write(0);    

  pinMode(buzzer, OUTPUT);

  lcd.begin(16, 2);
  lcd.print("Initializing...");
  delay(1500);
  lcd.clear();

  // Load password from EEPROM
  password = readPasswordFromEEPROM();
  if (password == "") {
    password = defaultPassword;
    savePasswordToEEPROM(password);
  }

  lcd.print("Welcome User!");
  delay(2000);
  lcd.clear();
  lcd.print("Enter Password:");
}

// -------------------------------------------
// Loop function
// -------------------------------------------
void loop() {
  char key = keypad.getKey();

  if (key) {
    if (key == '#') {        // Submit
      checkPassword();
      input_password = "";
    }
    else if (key == '*') {   // Reset input
      input_password = "";
      lcd.clear();
      lcd.print("Enter Password:");
    }
    else if (key == 'A') {   // Change password mode
      changePassword();
    }
    else {
      input_password += key;
      lcd.setCursor(0, 1);
      lcd.print(input_password);
    }
  }
}

// -------------------------------------------
// Check password function
// -------------------------------------------
void checkPassword() {
  lcd.clear();
  lcd.print("Checking...");
  delay(1000);
  lcd.clear();

  if (input_password == password) {
    lcd.print("Access Granted");

    // ---------- Auto-lock sequence ----------
    // Step 1: Latch opens first, stays 9 sec
    servoLatch.write(90);     
    delay(9000);              

    // Step 2: Door opens 1 sec after latch, stays 7 sec
    delay(1000);              
    servoDoor.write(90);      
    delay(7000);              

    // Step 3: Door closes first
    servoDoor.write(0);       
    delay(500);               

    // Step 4: Latch closes last
    servoLatch.write(0);      

    // ---------- End of auto-lock sequence ----------

    lcd.clear();
    lcd.print("Door Locked");
    delay(1500);
    lcd.clear();
    lcd.print("Enter Password:");

    attempts = 0;              
  } 
  else {
    attempts++;
    lcd.print("Access Denied");
    digitalWrite(buzzer, HIGH);
    delay(1000);
    digitalWrite(buzzer, LOW);
    
    if (attempts >= maxAttempts) {
      lcd.clear();
      lcd.print("LOCKED OUT!");
      for (int i = 0; i < 5; i++) {
        digitalWrite(buzzer, HIGH);
        delay(300);
        digitalWrite(buzzer, LOW);
        delay(300);
      }
      attempts = 0;  
    }

    delay(1000);
    lcd.clear();
    lcd.print("Enter Password:");
  }
}

// -------------------------------------------
// Change password function
// -------------------------------------------
void changePassword() {
  lcd.clear();
  lcd.print("Change Password");
  delay(1000);
  lcd.clear();
  lcd.print("New Password:");

  String newPass = "";

  while (true) {
    char key = keypad.getKey();
    if (key) {
      if (key == '#') {           
        password = newPass;
        savePasswordToEEPROM(password);
        lcd.clear();
        lcd.print("Password Saved!");
        delay(1500);
        lcd.clear();
        lcd.print("Enter Password:");
        break;
      }
      else if (key == '*') {      
        newPass = "";
        lcd.clear();
        lcd.print("New Password:");
      }
      else {
        newPass += key;
        lcd.setCursor(0, 1);
        lcd.print(newPass);
      }
    }
  }
}

// -------------------------------------------
// EEPROM save function
// -------------------------------------------
void savePasswordToEEPROM(String pass) {
  for (int i = 0; i < 10; i++) {
    if (i < pass.length()) {
      EEPROM.write(i, pass[i]);
    } else {
      EEPROM.write(i, 0);
    }
  }
}

// -------------------------------------------
// EEPROM read function
// -------------------------------------------
String readPasswordFromEEPROM() {
  String pass = "";
  for (int i = 0; i < 10; i++) {
    char c = EEPROM.read(i);
    if (c == 0) break;
    pass += c;
  }
  return pass;
}
